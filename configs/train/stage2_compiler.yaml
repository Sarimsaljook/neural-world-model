stage:
  name: stage2_compiler
  entrypoint: nwm_core.train.stages.stage2_compiler

seed: 1337

paths:
  run_root: outputs/train/${stage.name}
  data_root: assets/training_data
  ckpt_root: ${paths.run_root}/checkpoints
  report_root: ${paths.run_root}/reports

configs:
  data:
    ssv2: ${configs.data.ssv2}

device:
  accelerator: cuda
  precision: bf16
  cudnn_benchmark: true

data:
  dataset: ${configs.data.ssv2}
  num_workers: 14
  pin_memory: true
  persistent_workers: true
  prefetch_factor: 4

train:
  max_steps: 120000
  eval_every: 2000
  ckpt_every: 5000
  log_every: 50
  grad_accum: 1
  batch_size: 16
  clip_grad_norm: 1.0

init:
  encoder_ckpt: outputs/train/stage1_encoder/checkpoints/last.pt
  strict: false

model:
  train_parts:
    encoder: false
    compiler: true
    mechanisms: false
    intuition: false
    memory: false
    planning: false

  compiler:
    max_entities: 32
    track_iou_gate: 0.30
    track_emb_gate: 0.70
    event_smoothing: 0.85

loss:
  weights:
    id_consistency: 1.0
    relation_consistency: 1.0
    event_boundary: 1.0
    graph_sparsity: 0.05

optim:
  name: adamw
  lr: 1.6e-4
  betas: [0.9, 0.95]
  wd: 0.02
  warmup_steps: 2000
  schedule: cosine
  min_lr: 1.0e-6

ema:
  enable: true
  decay: 0.9998

amp:
  enable: true

checkpoint:
  save_last: true
  save_best: true
  metric: val/loss
  mode: min
