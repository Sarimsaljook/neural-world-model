stage:
  name: stage3_mechanisms
  entrypoint: nwm_core.train.stages.stage3_mechanisms

seed: 1337

paths:
  run_root: outputs/train/${stage.name}
  data_root: assets/training_data
  ckpt_root: ${paths.run_root}/checkpoints
  report_root: ${paths.run_root}/reports

configs:
  data:
    ssv2: ${configs.data.ssv2}

device:
  accelerator: cuda
  precision: bf16
  cudnn_benchmark: true

data:
  dataset: ${configs.data.ssv2}
  num_workers: 14
  pin_memory: true
  persistent_workers: true
  prefetch_factor: 4

train:
  max_steps: 100000
  eval_every: 2000
  ckpt_every: 5000
  log_every: 50
  grad_accum: 1
  batch_size: 20
  clip_grad_norm: 1.0

init:
  encoder_ckpt: outputs/train/stage1_encoder/checkpoints/last.pt
  compiler_ckpt: outputs/train/stage2_compiler/checkpoints/last.pt
  strict: false

model:
  train_parts:
    encoder: false
    compiler: false
    mechanisms: true
    intuition: false
    memory: false
    planning: false

  mechanisms:
    router_topk: 3
    min_p_activate: 0.55
    library:
      enable_contact: true
      enable_contain: true
      enable_support: true
      enable_slider: true
      enable_hinge: true
      enable_rigid: true
      enable_grasp: true
      enable_deform: true

loss:
  weights:
    mech_class: 1.0
    mech_params: 0.5
    event_alignment: 1.0

optim:
  name: adamw
  lr: 1.6e-4
  betas: [0.9, 0.95]
  wd: 0.02
  warmup_steps: 2000
  schedule: cosine
  min_lr: 1.0e-6

ema:
  enable: true
  decay: 0.9998

amp:
  enable: true

checkpoint:
  save_last: true
  save_best: true
  metric: val/loss
  mode: min
